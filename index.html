import React, { useState, useRef, useEffect } from 'react';

// Language data
const translations = {
    en: {
        title: "Arogya Mitra",
        tagline: "Your all-in-one health assistant.",
        tabDiagnosis: "Skin Diagnosis",
        tabChatbot: "Chatbot Assistant",
        diagnosisInstructions: "Upload an image or take a photo to get a descriptive analysis.",
        disclaimer: "Disclaimer: This is for educational purposes only and not a substitute for professional medical advice. Always consult a healthcare professional.",
        imagePlaceholder: "Image Preview",
        uploadButton: "Upload Image",
        takePhotoButton: "Take a Photo",
        capturePhotoButton: "Capture Photo",
        switchCameraButton: "Switch Camera",
        analyzeButton: "Analyze Image",
        analyzing: "Analyzing...",
        analysisResults: "Analysis Results",
        diseaseName: "Disease Name:",
        confidenceScore: "Confidence Score:",
        symptomsTitle: "Common Symptoms",
        basicPrecautionsTitle: "Precautions and Tips",
        precautionsDefault: [
            "Cleanse gently: Wash your face and body with a mild, pH-balanced cleanser.",
            "Moisturize regularly: Keep your skin hydrated with a moisturizer suitable for your skin type.",
            "Protect from the sun: Use broad-spectrum sunscreen with an SPF of 30 or higher daily, even on cloudy days."
        ],
        precautionsAcne: [
            "Wash your face twice a day with a gentle cleanser.",
            "Avoid touching your face to prevent spreading bacteria.",
            "Use non-comedogenic (pore-clogging) products.",
            "Do not pop pimples, as this can cause scarring."
        ],
        precautionsEczema: [
            "Keep your skin moisturized, especially after bathing.",
            "Avoid triggers like harsh soaps, detergents, and perfumes.",
            "Use lukewarm water for baths or showers.",
            "Wear loose, cotton clothing to prevent skin irritation."
        ],
        precautionsFungal: [
            "Keep the affected area clean and dry.",
            "Use an antifungal cream or powder as directed.",
            "Avoid sharing personal items like towels, hats, or combs.",
            "Wear clean, breathable clothing and change it daily."
        ],
        precautionsHealthy: [
            "Maintain a balanced diet and stay hydrated.",
            "Use sunscreen daily to protect your skin from sun damage.",
            "Cleanse and moisturize your skin regularly to keep it healthy.",
            "Avoid smoking and excessive alcohol consumption, which can harm your skin."
        ],
        precautionsDisclaimer: "These are general tips. For specific concerns, consult a healthcare professional.",
        
        chatbotInstructions: "Ask me anything about common skin conditions and health.",
        chatbotPlaceholder: "Type your message...",
        sendButton: "Send",
        chatbotInitialMessage: "Ask me anything about common skin conditions and health.",
        networkError: "I'm experiencing some technical difficulties. Please try again later.",
        apiError: "I'm sorry, I couldn't get a response. Please try again.",
        cameraError: "Could not access camera. Please check your permissions.",
        browserError: "Your browser does not support camera access.",
        uploadError: "Please upload an image or take a photo first.",
        analysisFailed: "Analysis failed. The AI couldn't provide a structured response. Please try a different image.",
        language: "Language",
        langInstruction: "in English",
        photoTips: "Tips for a better photo:",
        tip1: "Ensure good lighting, preferably natural light.",
        tip2: "Take a clear, focused picture of the affected area.",
        tip3: "Remove any jewelry or clothing that might block the view."
    },
    hi: {
        title: "आरोग्य मित्र",
        tagline: "आपका स्वास्थ्य सहायक",
        tabDiagnosis: "त्वचा की जांच",
        tabChatbot: "चैटबॉट सहायक",
        diagnosisInstructions: "जांच के लिए एक तस्वीर अपलोड करें या खींचें।",
        disclaimer: "अस्वीकरण: यह केवल शैक्षिक उद्देश्यों के लिए है और पेशेवर चिकित्सा सलाह का विकल्प नहीं है। हमेशा एक स्वास्थ्य पेशेवर से परामर्श करें।",
        imagePlaceholder: "छवि पूर्वावलोकन",
        uploadButton: "छवि अपलोड करें",
        takePhotoButton: "तस्वीर खींचें",
        capturePhotoButton: "तस्वीर कैप्चर करें",
        switchCameraButton: "कैमरा बदलें",
        analyzeButton: "जांच करें",
        analyzing: "जांच हो रही है...",
        analysisResults: "जांच के परिणाम",
        diseaseName: "रोग का नाम:",
        confidenceScore: "विश्वास स्कोर:",
        symptomsTitle: "आम लक्षण",
        basicPrecautionsTitle: "सावधानियां और सुझाव",
        precautionsDefault: [
            "धीरे से साफ करें: अपनी त्वचा को साफ करने के लिए हल्के साबुन का उपयोग करें।",
            "नियमित रूप से मॉइस्चराइज़ करें: अपनी त्वचा को सूखा होने से बचाने के लिए मॉइस्चराइजर का उपयोग करें।",
            "धूप से बचाएं: रोजाना धूप से बचाने वाली क्रीम (SPF 30 या उससे अधिक) का उपयोग करें।"
        ],
        precautionsAcne: [
            "दिन में दो बार हल्के क्लीन्ज़र से चेहरा धोएं।",
            "बैक्टीरिया फैलने से रोकने के लिए चेहरे को छूने से बचें।",
            "ऐसे उत्पादों का उपयोग करें जो छिद्रों को बंद न करें।",
            "मुंहासों को फोड़ें नहीं, इससे निशान पड़ सकते हैं।"
        ],
        precautionsEczema: [
            "त्वचा को मॉइस्चराइज रखें, खासकर नहाने के बाद।",
            "कठोर साबुन, डिटर्जेंट और परफ्यूम जैसी चीजों से बचें।",
            "स्नान के लिए गुनगुने पानी का उपयोग करें।",
            "त्वचा में जलन से बचने के लिए ढीले, सूती कपड़े पहनें।"
        ],
        precautionsFungal: [
            "प्रभावित क्षेत्र को साफ और सूखा रखें।",
            "एंटीफंगल क्रीम या पाउडर का उपयोग करें।",
            "तौलिए, टोपी या कंघी जैसी व्यक्तिगत चीजें साझा करने से बचें।",
            "रोजाना साफ, हवादार कपड़े पहनें।"
        ],
        precautionsHealthy: [
            "संतुलित आहार लें और हाइड्रेटेड रहें।",
            "सूर्य की क्षति से अपनी त्वचा की रक्षा के लिए प्रतिदिन सनस्क्रीन का उपयोग करें।",
            "अपनी त्वचा को स्वस्थ रखने के लिए इसे नियमित रूप से साफ और मॉइस्चराइज़ करें।",
            "धूम्रपान और अत्यधिक शराब के सेवन से बचें, जो आपकी त्वचा को नुकसान पहुंचा सकते हैं।"
        ],
        precautionsDisclaimer: "यह सामान्य सुझाव हैं। विशिष्ट समस्याओं के लिए, स्वास्थ्य पेशेवर से परामर्श लें।",
        chatbotInstructions: "त्वचा की समस्याओं के बारे में कुछ भी पूछें।",
        chatbotPlaceholder: "अपना संदेश लिखें...",
        sendButton: "भेजें",
        chatbotInitialMessage: "त्वचा की समस्याओं के बारे में कुछ भी पूछें।",
        networkError: "कुछ तकनीकी समस्या है। कृपया फिर से कोशिश करें।",
        apiError: "मुझे जवाब नहीं मिल सका। कृपया फिर से कोशिश करें।",
        cameraError: "कैमरा तक पहुंच नहीं मिल रही है। कृपया अपनी अनुमतियां जांचें।",
        browserError: "आपका ब्राउज़र कैमरा का समर्थन नहीं करता है।",
        uploadError: "कृपया पहले एक तस्वीर अपलोड करें या खींचें।",
        analysisFailed: "जांच असफल रही। कृपया एक अलग तस्वीर का प्रयास करें।",
        language: "भाषा",
        langInstruction: "in Hindi",
        photoTips: "बेहतर फोटो के लिए सुझाव:",
        tip1: "अच्छी रोशनी सुनिश्चित करें, अधिमानतः प्राकृतिक प्रकाश।",
        tip2: "प्रभावित क्षेत्र का एक स्पष्ट, केंद्रित चित्र लें।",
        tip3: "कोई भी गहने या कपड़े हटा दें जो दृश्य को अवरुद्ध कर सकते हैं।"
    },
    mr: {
        title: "आरोग्य मित्र",
        tagline: "तुमचा आरोग्य सहाय्यक",
        tabDiagnosis: "त्वचा तपासणी",
        tabChatbot: "चॅटबॉट सहाय्यक",
        diagnosisInstructions: "तपासणीसाठी एक फोटो अपलोड करा किंवा काढा.",
        disclaimer: "अस्वीकरण: हे केवळ शैक्षणिक उद्देशांसाठी आहे आणि व्यावसायिक वैद्यकीय सल्ल्याचा पर्याय नाही. नेहमी आरोग्य व्यावसायिकाचा सल्ला घ्या.",
        imagePlaceholder: "प्रतिमा पूर्वावलोकन",
        uploadButton: "फोटो अपलोड करा",
        takePhotoButton: "फोटो काढा",
        capturePhotoButton: "फोटो कॅप्चर करा",
        switchCameraButton: "कॅमेरा बदला",
        analyzeButton: "तपासणी करा",
        analyzing: "तपासणी होत आहे...",
        analysisResults: "तपासणीचे परिणाम",
        diseaseName: "रोगाचे नाव:",
        confidenceScore: "विश्वास गुण:",
        symptomsTitle: "सामान्य लक्षणे",
        basicPrecautionsTitle: "सावधानता आणि उपाय",
        precautionsDefault: [
            "हलक्या हाताने स्वच्छ करा: चेहरा आणि शरीर स्वच्छ करण्यासाठी सौम्य साबणाचा वापर करा.",
            "नेहमी मॉइश्चराइझ करा: त्वचा कोरडी होऊ नये म्हणून मॉइश्चरायझरचा वापर करा.",
            "सूर्यापासून संरक्षण करा: रोज सनस्क्रीन (SPF 30 किंवा अधिक) वापरा."
        ],
        precautionsAcne: [
            "दिवसातून दोनदा हलक्या क्लीन्झरने चेहरा धुवा.",
            "बॅक्टेरिया पसरू नये म्हणून चेहरा स्पर्श करणे टाळा.",
            "अशी उत्पादने वापरा जी छिद्रे बंद करत नाहीत.",
            "मुरुम फोडू नका, यामुळे डाग पडू शकतात."
        ],
        precautionsEczema: [
            "त्वचा मॉइश्चराइज ठेवा, खासकरून अंघोळीनंतर.",
            "कठोर साबण, डिटर्जंट आणि परफ्यूम टाळा.",
            "आंघोळीसाठी कोमट पाण्याचा वापर करा.",
            "त्वचेला त्रास होऊ नये म्हणून सैल, सुती कपडे घाला."
        ],
precautionsFungal: [
            "बाधित क्षेत्र स्वच्छ आणि कोरडे ठेवा.",
            "निर्देशानुसार अँटीफंगल क्रीम किंवा पावडर वापरा.",
            "टॉवेल, टोपी किंवा कंगवा यासारख्या वैयक्तिक वस्तू सामायिक करणे टाळा.",
            "रोज स्वच्छ आणि हवादार कपडे घाला."
        ],
        precautionsHealthy: [
            "संतुलित आहार घ्या आणि पुरेसे पाणी प्या.",
            "त्वचेचे सूर्याच्या हानीपासून संरक्षण करण्यासाठी दररोज सनस्क्रीन वापरा.",
            "त्वचा निरोगी ठेवण्यासाठी ती नियमितपणे स्वच्छ आणि मॉइश्चराइझ करा.",
            "धूम्रपान आणि जास्त मद्यपान टाळा, जे त्वचेला हानी पोहोचवू शकतात."
        ],
        precautionsDisclaimer: "हे सामान्य उपाय आहेत. विशिष्ट समस्यांसाठी, आरोग्य व्यावसायिकाचा सल्ला घ्या.",
        chatbotInstructions: "त्वचा की समस्यांबद्दल काहीही विचारा.",
        chatbotPlaceholder: "तुमचा संदेश टाइप करा...",
        sendButton: "पाठवा",
        chatbotInitialMessage: "त्वचेच्या समस्यांबद्दल काहीही विचारा.",
        networkError: "तांत्रिक समस्या आहे. कृपया पुन्हा प्रयत्न करा.",
        apiError: "मला प्रतिसाद मिळाला नाही. कृपया पुन्हा प्रयत्न करा.",
        cameraError: "कॅमेरा वापरता येत नाही. कृपया परवानगी तपासा.",
        browserError: "तुमचा ब्राउझर कॅमेराला सपोर्ट करत नाही.",
        uploadError: "कृपया आधी एक फोटो अपलोड करा किंवा काढा.",
        analysisFailed: "तपासणी अयशस्वी झाली. कृपया वेगळा फोटो वापरून पहा.",
        language: "भाषा",
        langInstruction: "in Marathi",
        photoTips: "चांगल्या फोटोसाठी काही टिप्स:",
        tip1: "चांगली प्रकाशयोजना सुनिश्चित करा, शक्यतो नैसर्गिक प्रकाश.",
        tip2: "बाधित भागाचा स्पष्ट, लक्ष केंद्रित केलेला फोटो घ्या.",
        tip3: "कोणतेही दागिने किंवा कपडे काढून टाका ज्यामुळे दृश्य अवरोधित होऊ शकते."
    }
};

const diseaseSymptoms = {
    en: {
        "acne": ["Red bumps or whiteheads on the skin.", "Oily skin.", "Painful cysts under the skin."],
        "eczema": ["Dry, itchy patches of skin.", "Red or brownish-gray patches.", "Small, raised bumps that may leak fluid."],
        "psoriasis": ["Red patches covered with thick, silvery scales.", "Dry, cracked skin that may bleed.", "Itching, burning, or soreness."],
        "fungal infection": ["Red, scaly rash in a ring shape.", "Itching or burning sensation.", "Cracked or peeling skin, especially between toes."],
        "healthy skin": ["Even tone and texture.", "No blemishes or rashes.", "Feels soft and supple."]
    },
    hi: {
        "acne": ["त्वचा पर लाल दाने या सफेद सिर वाले दाने।", "तैलीय त्वचा।", "त्वचा के नीचे दर्दनाक सिस्ट।"],
        "eczema": ["त्वचा पर सूखे, खुजली वाले धब्बे।", "लाल या भूरे-भूरे धब्बे।", "छोटे, उभरे हुए दाने जिनमें से तरल पदार्थ निकल सकता है।"],
        "psoriasis": ["मोटे, चांदी के रंग की पपड़ी से ढके लाल धब्बे।", "सूखी, फटी हुई त्वचा जिसमें से खून बह सकता है।", "खुजली, जलन, या दर्द।"],
        "fungal infection": ["अंगूठी के आकार में लाल, पपड़ीदार दाने।", "खुजली या जलन की भावना।", "सूखी या छिलती हुई त्वचा, खासकर पैर की उंगलियों के बीच।"],
        "healthy skin": ["समान रंग और बनावट।", "कोई दाग या दाने नहीं।", "नरम और मुलायम महसूस होती है।"]
    },
    mr: {
        "acne": ["त्वचेवर लाल पुरळ किंवा पांढरे डाग.", "तेलकट त्वचा.", "त्वचेखाली वेदनादायक गाठी."],
        "eczema": ["त्वचेवर कोरडे, खाज सुटणारे चट्टे.", "लाल किंवा तपकिरी-राखाडी रंगाचे चट्टे.", "लहान, वाढलेले पुरळ ज्यातून द्रव बाहेर येऊ शकतो."],
        "psoriasis": ["जाड, चांदीच्या रंगाच्या खपल्यांनी झाकलेले लाल चट्टे.", "कोरडी, भेगाळलेली त्वचा ज्यातून रक्त येऊ शकते.", "खाज, जळजळ किंवा वेदना."],
        "fungal infection": ["गोल आकारात लाल, खपल्या असलेली पुरळ.", "खाज किंवा जळजळ होण्याची भावना.", "कोरडी किंवा सोललेली त्वचा, विशेषतः पायाच्या बोटांच्या मध्ये."],
        "healthy skin": ["समान रंग आणि पोत.", "कोणतेही डाग किंवा पुरळ नाही.", "मऊ आणि मुलायम वाटते."]
    }
};

// Main application component that combines all features
const App = () => {
    // State to manage the current language
    const [locale, setLocale] = useState('en');
    const t = translations[locale];

    // State to manage which feature is currently active ('diagnosis' or 'chatbot')
    const [activeTab, setActiveTab] = useState('diagnosis');

    // --- State and Refs for Skin Diagnosis Feature ---
    const [imageSrc, setImageSrc] = useState(null);
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [diagnosis, setDiagnosis] = useState(null);
    const [diagnosisErrorMessage, setDiagnosisErrorMessage] = useState('');
    const fileInputRef = useRef(null);
    const videoRef = useRef(null);
    const canvasRef = useRef(null);
    const [isCameraActive, setIsCameraActive] = useState(false);
    const [currentCamera, setCurrentCamera] = useState('environment');

    // --- State for Chatbot Assistant Feature ---
    const [chatHistory, setChatHistory] = useState([]);
    const [userMessage, setUserMessage] = useState('');
    const [isChatting, setIsChatting] = useState(false);
    const chatContainerRef = useRef(null);

    // Function to handle image upload from a file
    const handleImageUpload = (event) => {
        setDiagnosisErrorMessage('');
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
                setImageSrc(reader.result);
                setDiagnosis(null);
            };
            reader.readAsDataURL(file);
        }
    };

    // Function to start the camera stream
    const startCamera = (facingMode) => {
        setDiagnosisErrorMessage('');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            setIsCameraActive(true);
            navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false })
                .then(stream => {
                    videoRef.current.srcObject = stream;
                    videoRef.current.play();
                    setCurrentCamera(facingMode);
                })
                .catch(err => {
                    console.error("Error accessing the camera: ", err);
                    setDiagnosisErrorMessage(t.cameraError);
                    setIsCameraActive(false);
                });
        } else {
            setDiagnosisErrorMessage(t.browserError);
        }
    };

    // Function to handle taking a photo with the camera
    const handleTakePhoto = () => {
        startCamera('environment'); // Start with the back camera by default
    };

    // Function to switch between front and back cameras
    const switchCamera = () => {
        if (videoRef.current && videoRef.current.srcObject) {
            videoRef.current.srcObject.getTracks().forEach(track => track.stop());
        }
        const newCamera = currentCamera === 'environment' ? 'user' : 'environment';
        startCamera(newCamera);
    };

    // Function to capture the current frame from the video stream
    const capturePhoto = () => {
        if (videoRef.current && canvasRef.current) {
            const context = canvasRef.current.getContext('2d');
            canvasRef.current.width = videoRef.current.videoWidth;
            canvasRef.current.height = videoRef.current.videoHeight;
            context.drawImage(videoRef.current, 0, 0, canvasRef.current.width, canvasRef.current.height);
            const capturedImage = canvasRef.current.toDataURL('image/jpeg');
            setImageSrc(capturedImage);
            setDiagnosis(null);

            // Stop the camera stream
            const stream = videoRef.current.srcObject;
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
            setIsCameraActive(false);
        }
    };

    // Function to analyze the image using the Gemini API
    const analyzeImage = async () => {
        if (!imageSrc) {
            setDiagnosisErrorMessage(t.uploadError);
            return;
        }

        setIsAnalyzing(true);
        setDiagnosis(null);
        setDiagnosisErrorMessage('');

        try {
            const base64Data = imageSrc.split(',')[1];
            
            const prompt = "Analyze the skin image to identify a possible skin condition. Respond with a JSON object containing the 'diseaseName' and a 'confidenceScore' (a percentage from 0 to 100). Also, include a brief 'description' and a 'disclaimer' to consult a professional. If no specific disease is identified, use 'Healthy Skin' as the disease name.";
            
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg",
                                    data: base64Data
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "diseaseName": { "type": "STRING" },
                            "confidenceScore": { "type": "INTEGER" },
                            "description": { "type": "STRING" },
                            "disclaimer": { "type": "STRING" }
                        },
                        "propertyOrdering": ["diseaseName", "confidenceScore", "description", "disclaimer"]
                    }
                }
            };
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const maxRetries = 5;
            let retryCount = 0;
            let response;
            let result;

            while (retryCount < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        retryCount++;
                        continue;
                    }

                    result = await response.json();
                    break;
                } catch (err) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    console.error(`Fetch error: ${err}. Retrying in ${delay / 1000}s...`);
                    await new Promise(res => setTimeout(res, delay));
                    retryCount++;
                }
            }

            if (!result || !result.candidates || result.candidates.length === 0 || !result.candidates[0].content || !result.candidates[0].content.parts || result.candidates[0].content.parts.length === 0) {
                throw new Error("Invalid response from API.");
            }

            const jsonText = result.candidates[0].content.parts[0].text;
            const parsedDiagnosis = JSON.parse(jsonText);
            setDiagnosis(parsedDiagnosis);

        } catch (error) {
            console.error("Analysis failed:", error);
            setDiagnosisErrorMessage(t.analysisFailed);
            setDiagnosis(null);
        } finally {
            setIsAnalyzing(false);
        }
    };

    // Chatbot function to send a message and get a response
    const handleSendMessage = async () => {
        if (userMessage.trim() === '') return;

        const newUserMessage = { role: 'user', text: userMessage };
        const newChatHistory = [...chatHistory, newUserMessage];
        setChatHistory(newChatHistory);
        setUserMessage('');
        setIsChatting(true);

        // Dynamically create a prompt based on the selected language
        const prompt = `Provide a short and simple answer ${t.langInstruction} for a non-technical person about this skin health question: "${userMessage}". Answer in short sentences, like you would to a child or someone not familiar with complex medical terms.`;
        
        const payload = {
            contents: [{
                role: "user",
                parts: [{ text: prompt }]
            }]
        };

        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${AIzaSyA5Ou98NgRkZYzK8Y7hEMSRgmLGPudedjs}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
                const botMessage = result.candidates[0].content.parts[0].text;
                setChatHistory(prevChat => [...prevChat, { role: 'bot', text: botMessage }]);
            } else {
                setChatHistory(prevChat => [...prevChat, { role: 'bot', text: t.apiError }]);
            }

        } catch (error) {
            console.error("Chatbot error:", error);
            setChatHistory(prevChat => [...prevChat, { role: 'bot', text: t.networkError }]);
        } finally {
            setIsChatting(false);
        }
    };
    
    // Auto-scroll chat to the bottom
    useEffect(() => {
        if (chatContainerRef.current) {
            chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
        }
    }, [chatHistory, isChatting]);

    const getSymptomsList = () => {
        if (!diagnosis || !diagnosis.diseaseName) {
            return [];
        }

        const diseaseName = diagnosis.diseaseName.toLowerCase();
        for (const key in diseaseSymptoms[locale]) {
            if (diseaseName.includes(key)) {
                return diseaseSymptoms[locale][key].map((item, index) => <li key={index}>{item}</li>);
            }
        }
        return [];
    };

    const getPrecautionsList = () => {
        const selectedList = (diagnosis && diagnosis.diseaseName) ? 
            (
                diagnosis.diseaseName.toLowerCase().includes('acne') ? t.precautionsAcne :
                diagnosis.diseaseName.toLowerCase().includes('eczema') ? t.precautionsEczema :
                diagnosis.diseaseName.toLowerCase().includes('fungal') ? t.precautionsFungal :
                diagnosis.diseaseName.toLowerCase().includes('healthy') ? t.precautionsHealthy :
                t.precautionsDefault
            ) : t.precautionsDefault;

        return selectedList.map((item, index) => {
            const parts = item.split(':');
            if (parts.length > 1) {
                return <li key={index}><span className="font-semibold">{parts[0]}:</span>{parts.slice(1).join(':')}</li>;
            } else {
                return <li key={index}>{item}</li>;
            }
        });
    };


    return (
        <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4 font-sans flex flex-col items-center">
            <div className="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-8 max-w-4xl w-full mx-auto my-8">
                <h1 className="text-4xl font-extrabold text-center mb-6 text-indigo-600 dark:text-indigo-400">
                    {t.title}
                </h1>
                <p className="text-center text-lg mb-4">
                    {t.tagline}
                </p>
                <div className="flex justify-center mb-8 space-x-4">
                    <select
                        value={locale}
                        onChange={(e) => setLocale(e.target.value)}
                        className="p-2 rounded-md bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                    >
                        <option value="en">English</option>
                        <option value="hi">हिंदी</option>
                        <option value="mr">मराठी</option>
                    </select>
                </div>

                {/* Tab Navigation */}
                <div className="flex justify-center mb-8">
                    <button
                        onClick={() => setActiveTab('diagnosis')}
                        className={`px-6 py-3 rounded-t-lg font-semibold transition-all duration-200 ease-in-out ${activeTab === 'diagnosis' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`}
                    >
                        {t.tabDiagnosis}
                    </button>
                    <button
                        onClick={() => setActiveTab('chatbot')}
                        className={`px-6 py-3 rounded-t-lg font-semibold transition-all duration-200 ease-in-out ${activeTab === 'chatbot' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`}
                    >
                        {t.tabChatbot}
                    </button>
                </div>

                {/* Skin Diagnosis Section */}
                {activeTab === 'diagnosis' && (
                    <div className="flex flex-col items-center justify-center">
                        <p className="text-center text-md mb-8">
                            {t.diagnosisInstructions}
                            <span className="text-sm block mt-2 font-medium text-red-500">
                                {t.disclaimer}
                            </span>
                        </p>
                        {/* New section with photo tips */}
                        <div className="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-xl shadow-inner mb-6 w-full max-w-lg border-l-4 border-yellow-500">
                            <h3 className="text-lg font-bold text-yellow-800 dark:text-yellow-300 mb-2">{t.photoTips}</h3>
                            <ul className="list-disc list-inside text-sm text-yellow-700 dark:text-yellow-400 space-y-1">
                                <li>{t.tip1}</li>
                                <li>{t.tip2}</li>
                                <li>{t.tip3}</li>
                            </ul>
                        </div>
                        <div className="relative w-full max-w-lg h-96 bg-gray-200 dark:bg-gray-700 rounded-xl overflow-hidden shadow-inner flex items-center justify-center mb-6 border-4 border-dashed border-gray-400 dark:border-gray-600">
                            {imageSrc && !isCameraActive ? (
                                <img src={imageSrc} alt="Preview" className="object-contain h-full w-full" />
                            ) : isCameraActive ? (
                                <>
                                    <video ref={videoRef} className="object-cover h-full w-full" autoPlay playsInline muted></video>
                                    <canvas ref={canvasRef} style={{ display: 'none' }}></canvas>
                                </>
                            ) : (
                                <span className="text-gray-500 dark:text-gray-400 text-center p-4">{t.imagePlaceholder}</span>
                            )}
                        </div>
                        <div className="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-8 w-full justify-center">
                            <input type="file" accept="image/*" onChange={handleImageUpload} ref={fileInputRef} className="hidden" />
                            <button onClick={() => fileInputRef.current.click()} className="flex-1 px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg shadow-md transition-all transform hover:scale-105">
                                <i className="fas fa-upload mr-2"></i>{t.uploadButton}
                            </button>
                            {!isCameraActive ? (
                                <button onClick={handleTakePhoto} className="flex-1 px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg shadow-md transition-all transform hover:scale-105">
                                    <i className="fas fa-camera mr-2"></i>{t.takePhotoButton}
                                </button>
                            ) : (
                                <>
                                    <button onClick={capturePhoto} className="flex-1 px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-md transition-all transform hover:scale-105">
                                        <i className="fas fa-camera-retro mr-2"></i>{t.capturePhotoButton}
                                    </button>
                                    <button onClick={switchCamera} className="flex-1 px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-md transition-all transform hover:scale-105">
                                        <i className="fas fa-camera-rotate mr-2"></i>{t.switchCameraButton}
                                    </button>
                                </>
                            )}
                        </div>
                        <button
                            onClick={analyzeImage}
                            disabled={!imageSrc || isAnalyzing}
                            className={`w-full sm:w-1/2 px-8 py-4 text-white font-bold rounded-lg shadow-xl transition-all transform hover:scale-105 ${!imageSrc || isAnalyzing ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                        >
                            {isAnalyzing ? (
                                <span className="flex items-center justify-center">
                                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    {t.analyzing}
                                </span>
                            ) : (
                                t.analyzeButton
                            )}
                        </button>
                        {diagnosisErrorMessage && (
                            <div className="mt-8 bg-red-100 dark:bg-red-900 border-l-4 border-red-500 text-red-700 dark:text-red-300 p-4 rounded-lg w-full">
                                <p className="font-semibold">Error:</p>
                                <p>{diagnosisErrorMessage}</p>
                            </div>
                        )}
                        {diagnosis && (
                            <div className="mt-8 w-full">
                                <h2 className="text-2xl font-bold mb-4 text-center">{t.analysisResults}</h2>
                                <div className="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl shadow-inner">
                                    <h3 className="text-xl font-semibold mb-2 text-indigo-500">
                                        {t.diseaseName} <span className="text-gray-900 dark:text-gray-100">{diagnosis.diseaseName}</span>
                                    </h3>
                                    <h3 className="text-xl font-semibold mb-4 text-indigo-500">
                                        {t.confidenceScore} <span className="text-gray-900 dark:text-gray-100">{diagnosis.confidenceScore}%</span>
                                    </h3>
                                    <p className="whitespace-pre-wrap">{diagnosis.description}</p>
                                    <p className="mt-4 text-sm text-red-500 font-medium">{diagnosis.disclaimer}</p>
                                </div>
                                <div className="mt-8">
                                    <h2 className="text-2xl font-bold mb-4 text-center text-red-600 dark:text-red-400">
                                        {t.symptomsTitle}
                                    </h2>
                                    <div className="bg-red-50 dark:bg-red-900 p-6 rounded-xl shadow-inner border-2 border-red-300 dark:border-red-700">
                                        {getSymptomsList().length > 0 ? (
                                            <ul className="list-disc list-inside space-y-2">
                                                {getSymptomsList().map(item => item)}
                                            </ul>
                                        ) : (
                                            <p className="text-center text-red-700 dark:text-red-300">
                                                No specific symptoms found for this condition.
                                            </p>
                                        )}
                                    </div>
                                </div>
                                <div className="mt-8">
                                    <h2 className="text-2xl font-bold mb-4 text-center text-teal-600 dark:text-teal-400">
                                        {t.basicPrecautionsTitle}
                                    </h2>
                                    <div className="bg-teal-50 dark:bg-teal-900 p-6 rounded-xl shadow-inner border-2 border-teal-300 dark:border-teal-700">
                                        <p className="mb-4">
                                            {t.precautionsDisclaimer}
                                        </p>
                                        <ul className="list-disc list-inside space-y-2">
                                            {getPrecautionsList().map(item => item)}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {/* Chatbot Assistant Section */}
                {activeTab === 'chatbot' && (
                    <div className="flex flex-col h-full">
                        <div ref={chatContainerRef} className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-700 rounded-xl shadow-inner">
                            {chatHistory.length === 0 ? (
                                <div className="text-center text-gray-500 dark:text-gray-400 mt-20">
                                    <i className="fas fa-robot text-4xl mb-2 text-blue-400"></i>
                                    <p>{t.chatbotInitialMessage}</p>
                                </div>
                            ) : (
                                chatHistory.map((msg, index) => (
                                    <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`relative max-w-xs sm:max-w-md p-3 rounded-xl shadow-md ${msg.role === 'user' ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-bl-none'}`}>
                                            {msg.text}
                                        </div>
                                    </div>
                                ))
                            )}
                            {isChatting && (
                                <div className="flex justify-start">
                                    <div className="relative max-w-xs sm:max-w-md p-3 rounded-xl bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-gray-100 rounded-bl-none shadow-md">
                                        <span className="animate-pulse">...</span>
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="flex mt-4 space-x-2">
                            <input
                                type="text"
                                className="flex-1 p-3 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder={t.chatbotPlaceholder}
                                value={userMessage}
                                onChange={(e) => setUserMessage(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                disabled={isChatting}
                            />
                            <button
                                onClick={handleSendMessage}
                                disabled={isChatting || userMessage.trim() === ''}
                                className={`px-6 py-3 rounded-lg font-semibold shadow-md transition-all ${isChatting || userMessage.trim() === '' ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`}
                            >
                                {t.sendButton}
                            </button>
                        </div>
                    </div>
                )}
            </div>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
        </div>
    );
};

export default App;
